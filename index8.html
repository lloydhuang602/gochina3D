<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<title>è´¢äº‹ç¼˜å¥ç¦æ¨ç®—å™¨ï¼ˆå…¨çƒç‰ˆï¼‰</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body {
  font-family: "Noto Sans SC", sans-serif;
  background: #faf8f5;
  color: #333;
  margin: 20px;
}
.container { display: flex; gap: 20px; }
.left {
  width: 320px;
  background: #fff;
  border-radius: 8px;
  padding: 15px;
  box-shadow: 0 0 5px rgba(0,0,0,0.1);
}
.right {
  flex: 1;
  background: #fff;
  border-radius: 8px;
  padding: 15px;
  box-shadow: 0 0 5px rgba(0,0,0,0.1);
}
input, select, button {
  width: 100%;
  padding: 6px;
  margin: 6px 0;
  font-size: 14px;
}
button {
  background: #c85c32;
  color: #fff;
  border: none;
  border-radius: 4px;
  cursor: pointer;
}
button:hover { background: #b24d28; }
#log {
  font-size: 13px;
  color: #555;
  margin-top: 8px;
  white-space: pre-line;
  background:#f8f8f8;
  border-radius:6px;
  padding:8px;
  height: 220px;
  overflow-y: auto;
}
#interpretation {
  margin-top: 20px;
  padding: 12px 16px;
  background: #fdf8f4;
  border-radius: 6px;
  border-left: 4px solid #c85c32;
  font-size: 14px;
  line-height: 1.7em;
}
.container {
  display: flex;
  gap: 20px;
  align-items: flex-start;
}

/* ä¸­é—´æŠ¥å‘ŠåŒº */
.center {
  flex: 1;
  background: #fff;
  border-radius: 8px;
  padding: 15px;
  box-shadow: 0 0 5px rgba(0,0,0,0.1);
  min-width: 420px;
}

/* å³ä¾§é›·è¾¾å›¾åŒº */
.right {
  width: 400px;
  background: #fff;
  border-radius: 8px;
  padding: 15px;
  box-shadow: 0 0 5px rgba(0,0,0,0.1);
  text-align: center;
}
/* é›·è¾¾å›¾åŒºä¸Šæ–¹ä¿¡æ¯ */
#chart-info {
  text-align: center;
  font-size: 14px;
  line-height: 1.6;
  margin-bottom: 10px;
  color: #333;
}
#bazi-text {
  font-weight: 600;
  color: #333;
  margin-bottom: 4px;
}
#wuxing-text {
  color: #5a4333;
  font-weight: 500;
}
#wuxing-value {
  display: block;
  white-space: pre-line;
  line-height: 1.5;
}

</style>
</head>
<body>
<h2>è´¢äº‹ç¼˜å¥ç¦æ¨ç®—å™¨ï¼ˆå…¨çƒç‰ˆï¼‰</h2>

<div class="container">
  <div class="left">
    <label>å‡ºç”Ÿæ—¥æœŸï¼š</label>
    <input type="date" id="birthDate" value="1978-03-31">
    <label>å‡ºç”Ÿæ—¶é—´ï¼š</label>
    <input type="time" id="birthTime" value="22:00">
    <label>æ€§åˆ«ï¼š</label>
    <select id="genderSelect">
      <option value="M" selected>ç”·æ€§</option>
      <option value="F">å¥³æ€§</option>
    </select>
    <label>å›½å®¶ï¼š</label>
    <select id="countrySelect"></select>
    <label>åŸå¸‚ï¼š</label>
    <select id="citySelect"></select>
    <button id="calcBtn">å¼€å§‹æ¨ç®—</button>
    <div id="log">æ­£åœ¨åŠ è½½åŸå¸‚æ•°æ®ï¼Œè¯·ç¨å€™â€¦</div>
  </div>

  <!-- æ–°å¢ä¸­é—´åˆ—ï¼šæŠ¥å‘ŠåŒº -->
  <div class="center">
    <div id="result"></div>
    <div id="interpretation">ï¼ˆå‘½ç†æŠ¥å‘Šå°†åœ¨æ­¤æ˜¾ç¤ºï¼‰</div>
  </div>

<div class="right">
<div id="chart-info">
  <div id="bazi-text">ä½ çš„å…«å­—ï¼š<span id="bazi-value"></span></div>
  <div id="wuxing-text">ä½ çš„åŸºç¡€è¿åŠ¿ï¼ˆäº”è¡Œèƒ½é‡ï¼‰ï¼š<br><span id="wuxing-value"></span></div>
</div>

<!-- ğŸŒˆ æ–°å¢äº”è¡Œè¿›åº¦æ¡å®¹å™¨ï¼ˆè¿›åº¦æ¡ä¼šåœ¨è¿™é‡Œæ˜¾ç¤ºï¼‰ -->
<div id="wuxing_result" style="margin-top:10px; text-align:left;"></div>

<canvas id="chart" width="360" height="300"></canvas>

</div>
<hr>
<div id="practice_items_display" style="margin-top:10px;"></div>
 
 
</div>

<script>
let worldCities = [];
let chart;
let libraries = {};
let practiceModules = {};
let practiceFinalEndings = [];
let practiceItems = {};

// äº”åº“åŠ è½½
async function loadLibraries(){
  const files = ["wuxing_traits","career_advice","life_stage","practice_tips","combo_relations"];
  for(const f of files){
    const res = await fetch(`./data/${f}.json`);
    libraries[f] = await res.json();
  }
  console.log("âœ… äº”åº“åŠ è½½å®Œæˆ");
}

// åŸå¸‚æ•°æ®åŠ è½½
fetch("./data/worldcities50000.json")
  .then(r=>r.json())
  .then(data=>{
    worldCities=data;
    const countries=[...new Set(worldCities.map(c=>c.country))].sort();
    const sel=document.getElementById("countrySelect");
    countries.forEach(country=>{
      const opt=document.createElement("option");
      opt.value=country;
      opt.text=country;
      sel.appendChild(opt);
    });
    sel.value="China";
    populateCities("China");
    document.getElementById("log").textContent="ğŸŒ åŸå¸‚æ•°æ®åŠ è½½å®Œæˆã€‚";
  })
  .catch(e=>{
    document.getElementById("log").textContent="âŒ åŸå¸‚æ•°æ®åŠ è½½å¤±è´¥ï¼š" + e;
  });

// å›½å®¶å˜åŒ–æ—¶æ›´æ–°åŸå¸‚
document.getElementById("countrySelect").addEventListener("change",e=>{
  populateCities(e.target.value);
});

function populateCities(countryName){
  const cities=worldCities.filter(c=>c.country===countryName)
    .sort((a,b)=>b.pop-a.pop);
  const citySel=document.getElementById("citySelect");
  citySel.innerHTML="";
  cities.forEach(c=>{
    const opt=document.createElement("option");
    opt.value=c.city;
    opt.text=c.city;
    citySel.appendChild(opt);
  });
}

// å¹²æ”¯è®¡ç®—
const GAN=["ç”²","ä¹™","ä¸™","ä¸","æˆŠ","å·±","åºš","è¾›","å£¬","ç™¸"];
const ZHI=["å­","ä¸‘","å¯…","å¯","è¾°","å·³","åˆ","æœª","ç”³","é…‰","æˆŒ","äº¥"];
const WUXING_GAN=["æœ¨","æœ¨","ç«","ç«","åœŸ","åœŸ","é‡‘","é‡‘","æ°´","æ°´"];
const WUXING_ZHI=["æ°´","åœŸ","æœ¨","æœ¨","åœŸ","ç«","ç«","åœŸ","é‡‘","é‡‘","åœŸ","æ°´"];

function calcTrueSolarTime(dateStr,timeStr,lon){
  const [hour,minute]=timeStr.split(":").map(Number);
  const date=new Date(dateStr+"T"+timeStr+":00");
  const utcOffset=-date.getTimezoneOffset()/60;
  const solarOffset=(lon-utcOffset*15)/15;
  const localSolarTime=hour+minute/60+solarOffset;
  const correctedHour=(localSolarTime%24+24)%24;
  const dayShift=Math.floor(localSolarTime/24);
  const trueDate=new Date(date.getTime()+dayShift*24*3600*1000);
  return {hour:correctedHour,date:trueDate,offset:solarOffset};
}

function toJulianDay(y,m,d){
  let a=Math.floor((14-m)/12);
  let y1=y+4800-a;
  let m1=m+12*a-3;
  return d+Math.floor((153*m1+2)/5)+365*y1+Math.floor(y1/4)-Math.floor(y1/100)+Math.floor(y1/400)-32045;
}

function getGanZhi(y,m,d,hour){
  const cyclicalYear=(y-4)%60;
  const yGan=GAN[cyclicalYear%10], yZhi=ZHI[cyclicalYear%12];
  const cyclicalMonth=((y-1900)*12+m+12)%60;
  const mGan=GAN[cyclicalMonth%10], mZhi=ZHI[cyclicalMonth%12];
  const jd=toJulianDay(y,m,d);
  const cyclicalDay=(jd-toJulianDay(1900,1,1)+60)%60;
  const dGan=GAN[cyclicalDay%10], dZhi=ZHI[cyclicalDay%12];
  const idxGan=GAN.indexOf(dGan);
  const hZhiIndex=Math.floor((hour+1)/2)%12;
  const hZhi=ZHI[hZhiIndex];
  const hGan=GAN[(idxGan*2+hZhiIndex)%10];
  return {year:yGan+yZhi+"å¹´",month:mGan+mZhi+"æœˆ",day:dGan+dZhi+"æ—¥",hour:hGan+hZhi+"æ—¶",hZhiIndex};
}

document.getElementById("calcBtn").addEventListener("click",async ()=>{
  if(Object.keys(libraries).length===0) await loadLibraries();
  const log=document.getElementById("log");
  log.textContent="ğŸŸ¡ æ­£åœ¨è®¡ç®—ï¼Œè¯·ç¨å€™â€¦\n";

  const date=document.getElementById("birthDate").value;
  const time=document.getElementById("birthTime").value;
  const gender=document.getElementById("genderSelect").value;
  const country=document.getElementById("countrySelect").value;
  const city=document.getElementById("citySelect").value;

  let matched=worldCities.find(c=>c.city===city && c.country===country);
  if(!matched){
    const fallback=worldCities.filter(c=>c.country===country).sort((a,b)=>b.pop-a.pop)[0];
    matched=fallback;
    log.textContent+=`âš ï¸ åŸå¸‚æ•°æ®æœªåŒ¹é…ï¼Œè‡ªåŠ¨ä½¿ç”¨è¯¥å›½ä¸»è¦åŸå¸‚ï¼š${matched.city}\n`;
  }

  if(matched.country!==country){
    const sameCountry=worldCities.filter(c=>c.country===country).sort((a,b)=>b.pop-a.pop)[0];
    log.textContent+=`âš ï¸ åŸå¸‚ä¸å›½å®¶ä¸ç¬¦ï¼Œå·²æ”¹ä¸ºï¼š${sameCountry.city} (${country})\n`;
    matched=sameCountry;
  }

  const {hour,date:trueDate,offset}=calcTrueSolarTime(date,time,matched.lon);
  const y=trueDate.getFullYear(), m=trueDate.getMonth()+1, d=trueDate.getDate();
  const gz=getGanZhi(y,m,d,hour);

  const wcount={æœ¨:0,ç«:0,åœŸ:0,é‡‘:0,æ°´:0};
  [gz.year,gz.month,gz.day,gz.hour].forEach(s=>{
    const [gan,zhi]=s.replace(/[å¹´æœˆæ—¥æ™‚]/g,"").split("");
    if(GAN.includes(gan)) wcount[WUXING_GAN[GAN.indexOf(gan)]]+=0.6;
    if(ZHI.includes(zhi)) wcount[WUXING_ZHI[ZHI.indexOf(zhi)]]+=0.4;
  });
  const wufu={è´¢:wcount.ç«,äº‹:wcount.æœ¨,ç¼˜:wcount.é‡‘,å¥:wcount.åœŸ,ç¦:wcount.æ°´};
  const res={y,m,d,gz,wuxing:wcount,wufu,hour,trueDate,offset,city:matched.city,lat:matched.lat,lon:matched.lon,gender};

  showResult(res);
  buildReport(res,gender);
  log.textContent+=`ğŸŒ çœŸå¤ªé˜³æ—¶åå·®: ${(offset*60).toFixed(1)} åˆ†é’Ÿ\nğŸ•° çœŸå¤ªé˜³æ—¶: ${trueDate.toLocaleString()}\nğŸª¶ å…«å­—: ${gz.year} ${gz.month} ${gz.day} ${gz.hour}\nğŸŒ¿ äº”è¡Œç»Ÿè®¡: ${JSON.stringify(wcount)}\nğŸ’ äº”ç¦æ˜ å°„: ${JSON.stringify(wufu)}\n`;
});

async function showResult(res) {
  document.getElementById("bazi-value").textContent =
    `${res.gz.year} ${res.gz.month} ${res.gz.day} ${res.gz.hour}`;

  // ğŸ”¹ ç¡®ä¿åŠ è½½ç­‰çº§è¡¨
  if (!window.wuxingLevels) {
    const resp = await fetch("data/wuxing_levels.json");
    window.wuxingLevels = await resp.json();
    console.log("âœ… äº”è¡Œç­‰çº§è¡¨å·²åŠ è½½");
  }

  // ğŸ”¹ äº”è¡Œä¹˜ä»¥100
  for (let key in res.wuxing) {
    res.wuxing[key] = Math.round(res.wuxing[key] * 100);
  }

  const wuxingColors = {
    "æœ¨": "#2ecc71",
    "ç«": "#e67e22",
    "åœŸ": "#d4ac0d",
    "é‡‘": "#bdc3c7",
    "æ°´": "#3498db"
  };
  const nameMap = {
    "æœ¨": "äº‹ä¸šè¿",
    "ç«": "è´¢å¯Œè¿",
    "åœŸ": "å¥åº·è¿",
    "é‡‘": "å§»ç¼˜è¿",
    "æ°´": "ç¦æ°”è¿"
  };

  function getLevel(value) {
    const all = Object.values(window.wuxingLevels.levels_by_wuxing).flat();
    const step = window.wuxingLevels.max_value / all.length;
    const idx = Math.min(Math.floor(value / step), all.length - 1);
    return { name: all[idx] };
  }

  // âœ… å¤–å±‚ HTML ç´¯åŠ å˜é‡
  let wuxingHTML = `<b>ä½ çš„åŸºç¡€è¿åŠ¿ï¼ˆäº”è¡Œèƒ½é‡ä¸ä¿®ç‚¼ç­‰çº§è½´ï¼‰ï¼š</b><br>`;
  let totalValue = 0, count = 0;

  for (const [key, value] of Object.entries(res.wuxing)) {
    const percent = Math.min((value / window.wuxingLevels.max_value) * 100, 100);
    const color = wuxingColors[key] || "#999";
    totalValue += value; count++;

    // â›©ï¸ äº”è¡Œç‹¬ç«‹å¢ƒç•Œï¼ˆ10ä¸ªåŒå­—ï¼‰
    const levels = (window.wuxingLevels.levels_by_wuxing &&
                    window.wuxingLevels.levels_by_wuxing[key]) || [];
const tickHTML = levels.map((name, i) => {
  // ç­‰çº§è®¡ç®—ï¼Œä½¿ç”¨éçº¿æ€§åˆ†å¸ƒï¼ˆæŒ‡æ•°å‹ï¼Œå‰æœŸå¿«ã€åæœŸæ…¢ï¼‰
  const pos = Math.pow(i / (levels.length - 1), 3) * 100;
  const active = Math.abs(percent - pos) < 8;
  return `<span style="
    position:absolute;
    left:${pos}%;
    top:0;
    transform:translateX(-50%);
    font-size:11px;
    ${active ? `font-weight:700; color:${color};` : `color:#777;`}
    white-space:nowrap;
  ">${name}</span>`;
}).join("");
    // ğŸ§­ æ¯æ¡äº”è¡Œæ¡
    wuxingHTML += `
      <div style="margin:14px 0; padding:8px 10px; background:#fafafa; border-radius:8px; box-shadow:inset 0 0 3px rgba(0,0,0,0.05);">
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <div><b>${nameMap[key]}</b> (${key})</div>
          <div style="font-size:13px; color:#666;">${value} ç‚¹</div>
        </div>

        <div style="position:relative; width:100%; height:40px; margin-top:18px;">
          <!-- ç°è‰²åº•æ¡ -->
          <div style="
            position:absolute; left:0; top:18px;
            width:100%; height:10px;
            background:#f0f0f0; border-radius:6px;
          "></div>

          <!-- å½©æ¡è¿›åº¦ -->
          <div style="
            position:absolute; left:0; top:18px;
            height:10px; width:${percent}%;
            background:${color}; border-radius:6px;
            transition:width 0.6s ease-out;
          "></div>

          <!-- åˆ»åº¦æ ‡ç­¾ -->
          ${tickHTML}

          <!-- å½“å‰å€¼æŒ‡é’ˆ -->
          <div style="
            position:absolute;
            top:18px;
            left:${percent}%;
            transform:translate(-50%, -2px);
            width:4px; height:14px;
            background:${color};
            border-radius:2px;
            box-shadow:0 0 6px ${color};
          "></div>
        </div>
      </div>
    `;
  }

  // ğŸ”¹ æ€»ä½“ä¿®ç‚¼å±‚æ¬¡
  const avg = totalValue / count;
  const overallLvl = getLevel(avg);
  wuxingHTML = `
    <div style="margin-bottom:8px; font-weight:600; font-size:15px;">
      ğŸŒˆ <b>æ€»ä½“ä¿®ç‚¼å±‚æ¬¡ï¼š</b>${overallLvl.name}
    </div>
  ` + wuxingHTML;

  // è¾“å‡º
  const wuxingDiv = document.getElementById("wuxing_result");
  if (wuxingDiv) wuxingDiv.innerHTML = wuxingHTML;

  // é›·è¾¾å›¾
  const labels = ["è´¢å¯Œè¿(ç«)", "äº‹ä¸šè¿(æœ¨)", "å§»ç¼˜è¿(é‡‘)", "å¥åº·è¿(åœŸ)", "ç¦æ°”è¿(æ°´)"];
  const values = [res.wufu.è´¢, res.wufu.äº‹, res.wufu.ç¼˜, res.wufu.å¥, res.wufu.ç¦];
  if (chart) chart.destroy();
  chart = new Chart(document.getElementById("chart"), {
    type: "radar",
    data: {
      labels,
      datasets: [{
        label: "äº”ç¦åˆ†å¸ƒ",
        data: values,
        fill: true,
        borderColor: "#c85c32",
        backgroundColor: "rgba(200,92,50,0.2)"
      }]
    },
    options: {
      responsive: false,
      maintainAspectRatio: false,
      scales: {
        r: { min: 0, max: 6, ticks: { stepSize: 1 } }
      }
    }
  });
}


function pickRandom(arr){return arr[Math.floor(Math.random()*arr.length)];}

function buildReport(res, gender){
  const div=document.getElementById("interpretation");
  const main=Object.entries(res.wuxing).sort((a,b)=>b[1]-a[1])[0][0];
  const second=Object.entries(res.wuxing).sort((a,b)=>b[1]-a[1])[1][0];
  const wuxingLib = libraries["wuxing_traits"][main];

  let traits=[];
  let level = "å¹³";
  if (res.wuxing[main] > 1.1) level = "æ—º";
  else if (res.wuxing[main] < 0.9) level = "å¼±";

  if(wuxingLib && wuxingLib[level] && wuxingLib[level][gender]){
    const pool=wuxingLib[level][gender];
    traits.push(pickRandom(pool));
  }

  const careerPool = (
    libraries["career_advice"][main] &&
    libraries["career_advice"][main][level] &&
    libraries["career_advice"][main][level][gender]
  ) || [];

  let careerText = "";
  if (careerPool.length > 0) {
    const first = pickRandom(careerPool);
    careerText = first;
  }

  let lifeText="";
  const lifeLib=libraries["life_stage"][main];
  if(lifeLib && lifeLib[gender]){
    const stages=lifeLib[gender];
    lifeText = stages.join("<br>");
  }

  const comboKey=main+second;
  let comboLib=libraries["combo_relations"][comboKey];
  if(!comboLib){ 
    const reverseKey=second+main;
    comboLib=libraries["combo_relations"][reverseKey];
  }
  const comboText=comboLib?pickRandom(comboLib):"ï¼ˆæ­¤å‘½æ ¼äº”è¡Œèƒ½é‡åè°ƒï¼Œæš‚æ— æ˜æ˜¾ç›¸ç”Ÿç›¸å…‹ç‰¹å¾ï¼‰";

  let practiceText = "";
  if (!window.practiceModulesLoaded) {
    loadPracticeModules().then(() => {
      practiceText = generatePracticeReportFromData(res.wuxing);
      document.getElementById("practice_tips").innerHTML = practiceText;
    });
  } else {
    practiceText = generatePracticeReportFromData(res.wuxing);
    document.getElementById("practice_tips").innerHTML = practiceText;
  }

  const levelText = res.wuxing[main]>1.1 ? "æ—ºç››" : res.wuxing[main]<0.9 ? "åå¼±" : "å¹³è¡¡";
  const explainIntro = `ä½ çš„äº”è¡Œèƒ½é‡å›¾æ˜¾ç¤ºï¼Œ${main}æ°”æœ€å¼ºï¼ˆ${parseFloat(res.wuxing[main]).toFixed(2)}ï¼‰ï¼Œå±äº${levelText}çŠ¶æ€ã€‚`;

  const analysisText = `
    <p>ğŸ“œ <b>ç»¼åˆå‘½ç†åˆ†æï¼š</b></p>
    <p>${main}ä¸»äº”è¡Œï¼Œè±¡å¾ç€ä½ çš„æ ¸å¿ƒèƒ½é‡æ–¹å‘ã€‚</p>
    <p>${explainIntro}</p>
    <p>${traits.join("<br>")}</p>
    <p>ä»å‘½ç†ä¸Šçœ‹ï¼Œä½ çš„äº”è¡Œç»“æ„ä¸­ï¼Œ${main}æ°”æœ€æ˜¾ï¼Œ${second}æ°”ç›¸è¾…ï¼Œå½¢æˆâ€œ${second}${main}â€æ ¼å±€ã€‚</p>
    <p>${comboText}</p>
    <p>åœ¨ç°å®å±‚é¢ï¼Œä½ çš„äº‹ä¸šä¸ç¯å¢ƒé€‚åˆä»¥ä¸‹æ–¹å‘ï¼š</p>
    <p>${careerText}</p>
  `;
  div.innerHTML = `
    ${analysisText}
    <hr>
    <p>ğŸŒˆ <b>ä¿®è¡Œæå‡å»ºè®®ï¼š</b></p>
    <p id="practice_tips">(æ­£åœ¨ç”Ÿæˆä¿®è¡Œå»ºè®®...)</p>
    <hr>
    <p>ğŸ•° <b>å¤§è¿æµå¹´è¶‹åŠ¿ï¼š</b></p>
    <p>${lifeText}</p>
  `;

  if (!window.practiceModulesLoaded) {
    loadPracticeModules().then(() => {
      const practiceText = generatePracticeReportFromData(res.wuxing);
      const tipsDiv = document.getElementById("practice_tips");
      if (tipsDiv) tipsDiv.innerHTML = practiceText;
    });
  } else {
    const practiceText = generatePracticeReportFromData(res.wuxing);
    const tipsDiv = document.getElementById("practice_tips");
    if (tipsDiv) tipsDiv.innerHTML = practiceText;
  }

  async function loadPracticeModules() {
    const [mRes, iRes] = await Promise.all([
      fetch("data/practice_modules.json?ver=" + Date.now()),
      fetch("data/practice_items.json?ver=" + Date.now())
    ]);
    const mData = await mRes.json();
    practiceModules = mData.modules || mData;
    practiceFinalEndings = mData.finalEndings || [];
    practiceItems = await iRes.json();
    window.practiceModulesLoaded = true;
    console.log("âœ… ä¿®è¡Œæ¨¡å—å·²åŠ è½½");
  }

  function generatePracticeReportFromData(wuxingData) {
    if (!practiceModules || !Object.keys(practiceItems).length) 
      return "ä¿®è¡Œæ•°æ®å°šæœªåŠ è½½";

    let text = "";
    const usedItems = {};

    for (const wx of ["æœ¨","ç«","åœŸ","é‡‘","æ°´"]) {
      const val = wuxingData[wx];
      const çŠ¶æ€ = val >= 1.1 ? "æ—º" : val <= 0.9 ? "å¼±" : "å¹³";
      const å¼€ = pick(practiceModules[wx][çŠ¶æ€].å¼€å¤´);
      const ä¿® = pick(practiceModules[wx][çŠ¶æ€].ä¿®è¡Œ);
      const è¡Œ = pick(practiceModules[wx][çŠ¶æ€].è¡Œä¸º);
      const é¥° = pick(practiceModules[wx][çŠ¶æ€].é¥°å“);

      const itemList = practiceItems[wx] || [];
      const itemA = itemList.length ? pick(itemList) : null;
      const itemB = itemList.length ? pick(itemList) : null;

      let comboActionName = "ä¿®è¡Œä¾›ç¯";
      let itemNameOnly = "ä¾›ç¯";

      if (itemA) {
        const actA = itemA["åŠ¨ä½œ"] ? itemA["åŠ¨ä½œ"].trim() : "";
        const nameA = itemA["åç§°"] ? itemA["åç§°"].trim() : "";
        comboActionName = actA && nameA ? actA + nameA : nameA || actA || "ä¿®è¡Œ";
        usedItems[nameA] = itemA;
      }
      if (itemB) {
        const nameB = itemB["åç§°"] ? itemB["åç§°"].trim() : "";
        itemNameOnly = nameB || "ä¿®è¡Œ";
        usedItems[nameB] = itemB;
      }

      text += `<p><b>${getEmoji(wx)} ${getName(wx)}è¿ï¼ˆ${wx}ï¼‰</b><br>`;
      text += `${å¼€}${ä¿®}${è¡Œ.replace("{items}", comboActionName)}${é¥°.replace("{items}", itemNameOnly)}</p>`;
    }

    text += `<p><b>ç»“è®ºï¼š</b>${pick(practiceFinalEndings)}</p>`;
    displayUsedItems(usedItems);
    return text;
  }

  function pick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
  function getEmoji(wx){ return {æœ¨:"ğŸŒ¿",ç«:"ğŸ”¥",åœŸ:"ğŸŒ¾",é‡‘:"ğŸ’",æ°´:"ğŸ’§"}[wx] || "âœ¨"; }
  function getName(wx){ return {æœ¨:"äº‹ä¸š",ç«:"è´¢å¯Œ",åœŸ:"å¥åº·",é‡‘:"å§»ç¼˜",æ°´:"ç¦æ°”"}[wx] || wx; }

  function displayUsedItems(usedItems) {
    const container = document.getElementById("practice_items_display");
    if (!container) return;
    container.innerHTML = "<h4>ğŸª¶ æœ¬æ¬¡ä¿®è¡Œæ‰€ç”¨é“å…·</h4>";

    const rarityMultiplier = {
      "æ™®é€š": 1.0,
      "çç¨€": 1.5,
      "çµå“": 2.0,
      "ä»™å“": 3.0,
      "ç¥å“": 4.0
    };
    const rarityDuration = {
      "æ™®é€š": 3,
      "çç¨€": 7,
      "çµå“": 11,
      "ä»™å“": 15,
      "ç¥å“": 20
    };

    for (const [name, item] of Object.entries(usedItems)) {
      const base = item["basePrice"] || 0;
      const rarity = item["ç¨€æœ‰åº¦"] || "æ™®é€š";
      const finalPrice = Math.round(base * (rarityMultiplier[rarity] || 1));
      const boostValue = Math.round(base * 0.1);
      const duration = rarityDuration[rarity] || 3;

      let html = `<div style="border:1px solid #ddd; border-radius:8px; background:#fff; padding:8px 12px; margin:6px 0; box-shadow:0 0 4px rgba(0,0,0,0.05);">`;
      html += `<b>${item["åç§°"] || name}</b><br>`;
      html += `<small>ç±»å‹ï¼š</small>${item["ç±»å‹"] || ""}<br>`;
      html += `<small>åŠ¨ä½œï¼š</small>${item["åŠ¨ä½œ"] || ""}<br>`;
      html += `<small>é€‚ç”¨äº”è¡Œï¼š</small>${item["é€‚ç”¨äº”è¡Œ"] || ""}<br>`;
      html += `<small>ç¨€æœ‰åº¦ï¼š</small>${rarity}<br>`;
      html += `<small>åŸºç¡€ä»·æ ¼ï¼š</small>${base}<br>`;
      html += `<small>æœ€ç»ˆä»·æ ¼ï¼š</small>${finalPrice}<br>`;
      html += `<small>åŠ æˆå€¼ï¼š</small>${boostValue}<br>`;
      html += `<small>èƒ½é‡æŒç»­ï¼š</small>${duration} å¤©<br>`;
      html += `<small>è±¡å¾æ„ä¹‰ï¼š</small>${item["è±¡å¾æ„ä¹‰"] || ""}<br>`;
      html += `<small>è¯´æ˜ï¼š</small>${item["è¯´æ˜"] || ""}<br>`;
      html += `</div>`;
      container.innerHTML += html;
    }
  }
}
</script>
</body>
</html>
